{"version":3,"sources":["../../../next-server/server/image-optimizer.ts"],"names":["sharp","WEBP","PNG","JPEG","GIF","SVG","CACHE_VERSION","MODERN_TYPES","ANIMATABLE_TYPES","VECTOR_TYPES","imageOptimizer","server","req","res","parsedUrl","nextConfig","distDir","imageData","images","deviceSizes","imageSizes","domains","loader","sizes","render404","finished","headers","url","w","q","query","mimeType","getSupportedMimeType","accept","href","statusCode","end","Array","isArray","isAbsolute","startsWith","hrefParsed","URL","toString","_error","includes","protocol","hostname","width","parseInt","isNaN","quality","hash","getHash","imagesDir","hashDir","now","Date","files","promises","readdir","file","filename","extension","split","expireAt","Number","contentType","setHeader","pipe","unlink","upstreamBuffer","upstreamType","maxAge","upstreamRes","fetch","ok","status","Buffer","from","arrayBuffer","get","getMaxAge","_req","method","resBuffers","mockRes","Stream","Writable","write","chunk","push","isBuffer","_write","mockHeaders","writeHead","_status","_headers","Object","assign","getHeader","name","toLowerCase","getHeaders","getHeaderNames","keys","value","_implicitHeader","getRequestHandler","nodeUrl","parse","concat","err","vector","animate","require","error","code","message","logError","transformer","rotate","metaWidth","metadata","resize","webp","png","jpeg","optimizedBuffer","toBuffer","mkdir","recursive","writeFile","options","items","item","update","String","digest","replace","parseCacheControl","str","map","Map","directive","key","trim","set","minimum","age","endsWith","slice","n","Math","max"],"mappings":"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","sourcesContent":["import nodeUrl, { UrlWithParsedQuery } from 'url'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport { join } from 'path'\nimport { mediaType } from '@hapi/accept'\nimport { createReadStream, promises } from 'fs'\nimport { createHash } from 'crypto'\nimport Server from './next-server'\nimport { getContentType, getExtension } from './serve-static'\nimport { fileExists } from '../../lib/file-exists'\n// @ts-ignore no types for is-animated\nimport isAnimated from 'next/dist/compiled/is-animated'\nimport Stream from 'stream'\n\nlet sharp: typeof import('sharp')\n//const AVIF = 'image/avif'\nconst WEBP = 'image/webp'\nconst PNG = 'image/png'\nconst JPEG = 'image/jpeg'\nconst GIF = 'image/gif'\nconst SVG = 'image/svg+xml'\nconst CACHE_VERSION = 1\nconst MODERN_TYPES = [/* AVIF, */ WEBP]\nconst ANIMATABLE_TYPES = [WEBP, PNG, GIF]\nconst VECTOR_TYPES = [SVG]\n\ntype ImageData = {\n  deviceSizes: number[]\n  imageSizes: number[]\n  loader: string\n  path: string\n  domains?: string[]\n}\n\nexport async function imageOptimizer(\n  server: Server,\n  req: IncomingMessage,\n  res: ServerResponse,\n  parsedUrl: UrlWithParsedQuery\n) {\n  const { nextConfig, distDir } = server\n  const imageData: ImageData = nextConfig.images\n  const { deviceSizes = [], imageSizes = [], domains = [], loader } = imageData\n  const sizes = [...deviceSizes, ...imageSizes]\n\n  if (loader !== 'default') {\n    await server.render404(req, res, parsedUrl)\n    return { finished: true }\n  }\n\n  const { headers } = req\n  const { url, w, q } = parsedUrl.query\n  const mimeType = getSupportedMimeType(MODERN_TYPES, headers.accept)\n  let href: string\n\n  if (!url) {\n    res.statusCode = 400\n    res.end('\"url\" parameter is required')\n    return { finished: true }\n  } else if (Array.isArray(url)) {\n    res.statusCode = 400\n    res.end('\"url\" parameter cannot be an array')\n    return { finished: true }\n  }\n\n  let isAbsolute: boolean\n\n  if (url.startsWith('/')) {\n    href = url\n    isAbsolute = false\n  } else {\n    let hrefParsed: URL\n\n    try {\n      hrefParsed = new URL(url)\n      href = hrefParsed.toString()\n      isAbsolute = true\n    } catch (_error) {\n      res.statusCode = 400\n      res.end('\"url\" parameter is invalid')\n      return { finished: true }\n    }\n\n    if (!['http:', 'https:'].includes(hrefParsed.protocol)) {\n      res.statusCode = 400\n      res.end('\"url\" parameter is invalid')\n      return { finished: true }\n    }\n\n    if (!domains.includes(hrefParsed.hostname)) {\n      res.statusCode = 400\n      res.end('\"url\" parameter is not allowed')\n      return { finished: true }\n    }\n  }\n\n  if (!w) {\n    res.statusCode = 400\n    res.end('\"w\" parameter (width) is required')\n    return { finished: true }\n  } else if (Array.isArray(w)) {\n    res.statusCode = 400\n    res.end('\"w\" parameter (width) cannot be an array')\n    return { finished: true }\n  }\n\n  if (!q) {\n    res.statusCode = 400\n    res.end('\"q\" parameter (quality) is required')\n    return { finished: true }\n  } else if (Array.isArray(q)) {\n    res.statusCode = 400\n    res.end('\"q\" parameter (quality) cannot be an array')\n    return { finished: true }\n  }\n\n  const width = parseInt(w, 10)\n\n  if (!width || isNaN(width)) {\n    res.statusCode = 400\n    res.end('\"w\" parameter (width) must be a number greater than 0')\n    return { finished: true }\n  }\n\n  if (!sizes.includes(width)) {\n    res.statusCode = 400\n    res.end(`\"w\" parameter (width) of ${width} is not allowed`)\n    return { finished: true }\n  }\n\n  const quality = parseInt(q)\n\n  if (isNaN(quality) || quality < 1 || quality > 100) {\n    res.statusCode = 400\n    res.end('\"q\" parameter (quality) must be a number between 1 and 100')\n    return { finished: true }\n  }\n\n  const hash = getHash([CACHE_VERSION, href, width, quality, mimeType])\n  const imagesDir = join(distDir, 'cache', 'images')\n  const hashDir = join(imagesDir, hash)\n  const now = Date.now()\n\n  if (await fileExists(hashDir, 'directory')) {\n    const files = await promises.readdir(hashDir)\n    for (let file of files) {\n      const [filename, extension] = file.split('.')\n      const expireAt = Number(filename)\n      const contentType = getContentType(extension)\n      if (now < expireAt) {\n        if (contentType) {\n          res.setHeader('Content-Type', contentType)\n        }\n        createReadStream(join(hashDir, file)).pipe(res)\n        return { finished: true }\n      } else {\n        await promises.unlink(join(hashDir, file))\n      }\n    }\n  }\n\n  let upstreamBuffer: Buffer\n  let upstreamType: string | null\n  let maxAge: number\n\n  if (isAbsolute) {\n    const upstreamRes = await fetch(href)\n\n    if (!upstreamRes.ok) {\n      res.statusCode = upstreamRes.status\n      res.end('\"url\" parameter is valid but upstream response is invalid')\n      return { finished: true }\n    }\n\n    res.statusCode = upstreamRes.status\n    upstreamBuffer = Buffer.from(await upstreamRes.arrayBuffer())\n    upstreamType = upstreamRes.headers.get('Content-Type')\n    maxAge = getMaxAge(upstreamRes.headers.get('Cache-Control'))\n  } else {\n    try {\n      const _req: any = {\n        headers: req.headers,\n        method: req.method,\n        url: href,\n      }\n      const resBuffers: Buffer[] = []\n      const mockRes: any = new Stream.Writable()\n\n      mockRes.write = (chunk: Buffer | string) => {\n        resBuffers.push(Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk))\n      }\n      mockRes._write = (chunk: Buffer | string) => {\n        mockRes.write(chunk)\n      }\n\n      const mockHeaders: Record<string, string | string[]> = {}\n\n      mockRes.writeHead = (_status: any, _headers: any) =>\n        Object.assign(mockHeaders, _headers)\n      mockRes.getHeader = (name: string) => mockHeaders[name.toLowerCase()]\n      mockRes.getHeaders = () => mockHeaders\n      mockRes.getHeaderNames = () => Object.keys(mockHeaders)\n      mockRes.setHeader = (name: string, value: string | string[]) =>\n        (mockHeaders[name.toLowerCase()] = value)\n      mockRes._implicitHeader = () => {}\n      mockRes.finished = false\n      mockRes.statusCode = 200\n\n      await server.getRequestHandler()(_req, mockRes, nodeUrl.parse(href, true))\n      res.statusCode = mockRes.statusCode\n\n      upstreamBuffer = Buffer.concat(resBuffers)\n      upstreamType = mockRes.getHeader('Content-Type')\n      maxAge = getMaxAge(mockRes.getHeader('Cache-Control'))\n    } catch (err) {\n      res.statusCode = 500\n      res.end('\"url\" parameter is valid but upstream response is invalid')\n      return { finished: true }\n    }\n  }\n\n  if (upstreamType) {\n    const vector = VECTOR_TYPES.includes(upstreamType)\n    const animate =\n      ANIMATABLE_TYPES.includes(upstreamType) && isAnimated(upstreamBuffer)\n    if (vector || animate) {\n      res.setHeader('Content-Type', upstreamType)\n      res.end(upstreamBuffer)\n      return { finished: true }\n    }\n  }\n\n  const expireAt = maxAge * 1000 + now\n  let contentType: string\n\n  if (mimeType) {\n    contentType = mimeType\n  } else if (upstreamType?.startsWith('image/') && getExtension(upstreamType)) {\n    contentType = upstreamType\n  } else {\n    contentType = JPEG\n  }\n\n  if (!sharp) {\n    try {\n      // eslint-disable-next-line import/no-extraneous-dependencies\n      sharp = require('sharp')\n    } catch (error) {\n      if (error.code === 'MODULE_NOT_FOUND') {\n        error.message += '\\n\\nLearn more: https://err.sh/next.js/install-sharp'\n        server.logError(error)\n        if (upstreamType) {\n          res.setHeader('Content-Type', upstreamType)\n        }\n        res.end(upstreamBuffer)\n      }\n      throw error\n    }\n  }\n\n  try {\n    const transformer = sharp(upstreamBuffer)\n    transformer.rotate() // auto rotate based on EXIF data\n\n    const { width: metaWidth } = await transformer.metadata()\n\n    if (metaWidth && metaWidth > width) {\n      transformer.resize(width)\n    }\n\n    //if (contentType === AVIF) {\n    // Soon https://github.com/lovell/sharp/issues/2289\n    //}\n    if (contentType === WEBP) {\n      transformer.webp({ quality })\n    } else if (contentType === PNG) {\n      transformer.png({ quality })\n    } else if (contentType === JPEG) {\n      transformer.jpeg({ quality })\n    }\n\n    const optimizedBuffer = await transformer.toBuffer()\n    await promises.mkdir(hashDir, { recursive: true })\n    const extension = getExtension(contentType)\n    const filename = join(hashDir, `${expireAt}.${extension}`)\n    await promises.writeFile(filename, optimizedBuffer)\n    res.setHeader('Content-Type', contentType)\n    res.end(optimizedBuffer)\n  } catch (error) {\n    server.logError(error)\n    if (upstreamType) {\n      res.setHeader('Content-Type', upstreamType)\n    }\n    res.end(upstreamBuffer)\n  }\n\n  return { finished: true }\n}\n\nfunction getSupportedMimeType(options: string[], accept = ''): string {\n  const mimeType = mediaType(accept, options)\n  return accept.includes(mimeType) ? mimeType : ''\n}\n\nfunction getHash(items: (string | number | undefined)[]) {\n  const hash = createHash('sha256')\n  for (let item of items) {\n    hash.update(String(item))\n  }\n  // See https://en.wikipedia.org/wiki/Base64#Filenames\n  return hash.digest('base64').replace(/\\//g, '-')\n}\n\nfunction parseCacheControl(str: string | null): Map<string, string> {\n  const map = new Map<string, string>()\n  if (!str) {\n    return map\n  }\n  for (let directive of str.split(',')) {\n    let [key, value] = directive.trim().split('=')\n    key = key.toLowerCase()\n    if (value) {\n      value = value.toLowerCase()\n    }\n    map.set(key, value)\n  }\n  return map\n}\n\nexport function getMaxAge(str: string | null): number {\n  const minimum = 60\n  const map = parseCacheControl(str)\n  if (map) {\n    let age = map.get('s-maxage') || map.get('max-age') || ''\n    if (age.startsWith('\"') && age.endsWith('\"')) {\n      age = age.slice(1, -1)\n    }\n    const n = parseInt(age, 10)\n    if (!isNaN(n)) {\n      return Math.max(n, minimum)\n    }\n  }\n  return minimum\n}\n"]}